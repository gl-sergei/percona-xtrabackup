include/rpl_init.inc [topology=none]
SET @old_sql_notes= @@GLOBAL.SQL_NOTES;
SET GLOBAL SQL_NOTES= 0;
SET SESSION SQL_NOTES= 0;
CALL mtr.add_suppression('Statement violates GTID consistency:');
CALL mtr.add_suppression('Unsafe statement written to the binary log');
include/assert.inc [ENFORCE_GTID_CONSISTENCY should default to 0]
############ ENFORCE_GTID_CONSISTENCY=0 ############
SET GLOBAL ENFORCE_GTID_CONSISTENCY = 0;
SELECT @@GLOBAL.ENFORCE_GTID_CONSISTENCY;
@@GLOBAL.ENFORCE_GTID_CONSISTENCY
0
SET GLOBAL GTID_MODE = OFF_PERMISSIVE;
SET GLOBAL GTID_MODE = ON_PERMISSIVE;
******** GTID_MODE=2 ********
SET GLOBAL GTID_MODE = 2;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=UUID:NUMBER ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
ALTER TABLE t1 ADD COLUMN (b INT);
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
DROP TABLE t1;
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
******** GTID_MODE=1 ********
SET GLOBAL GTID_MODE = 1;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=UUID:NUMBER ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
ALTER TABLE t1 ADD COLUMN (b INT);
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
DROP TABLE t1;
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
******** GTID_MODE=0 ********
SET GLOBAL GTID_MODE = 0;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=0 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
############ ENFORCE_GTID_CONSISTENCY=1 ############
SET GLOBAL ENFORCE_GTID_CONSISTENCY = 1;
SELECT @@GLOBAL.ENFORCE_GTID_CONSISTENCY;
@@GLOBAL.ENFORCE_GTID_CONSISTENCY
1
SET GLOBAL GTID_MODE = OFF_PERMISSIVE;
SET GLOBAL GTID_MODE = ON_PERMISSIVE;
SET GLOBAL GTID_MODE = ON;
******** GTID_MODE=3 ********
SET GLOBAL GTID_MODE = 3;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=UUID:NUMBER ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
ALTER TABLE t1 ADD COLUMN (b INT);
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
DROP TABLE t1;
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=3 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
******** GTID_MODE=2 ********
SET GLOBAL GTID_MODE = 2;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=UUID:NUMBER ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
ALTER TABLE t1 ADD COLUMN (b INT);
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
DROP TABLE t1;
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
******** GTID_MODE=1 ********
SET GLOBAL GTID_MODE = 1;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=UUID:NUMBER ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
ALTER TABLE t1 ADD COLUMN (b INT);
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
DROP TABLE t1;
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
******** GTID_MODE=0 ********
SET GLOBAL GTID_MODE = 0;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=1 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
############ ENFORCE_GTID_CONSISTENCY=2 ############
SET GLOBAL ENFORCE_GTID_CONSISTENCY = 2;
SELECT @@GLOBAL.ENFORCE_GTID_CONSISTENCY;
@@GLOBAL.ENFORCE_GTID_CONSISTENCY
2
SET GLOBAL GTID_MODE = OFF_PERMISSIVE;
SET GLOBAL GTID_MODE = ON_PERMISSIVE;
******** GTID_MODE=2 ********
SET GLOBAL GTID_MODE = 2;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=UUID:NUMBER ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
ALTER TABLE t1 ADD COLUMN (b INT);
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
DROP TABLE t1;
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=2 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
******** GTID_MODE=1 ********
SET GLOBAL GTID_MODE = 1;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=UUID:NUMBER ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_SELECT
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
ERROR HY000: Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO myisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO tmyisam1 VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_NON_TRANSACTIONAL_TABLE
INSERT INTO innodb VALUES (1);
ERROR HY000: Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO myisam2 VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO myisam1 VALUES (1);
error ER_GTID_NEXT_TYPE_UNDEFINED_GROUP
INSERT INTO innodb VALUES (1);
ERROR HY000: When @@SESSION.GTID_NEXT is set to a GTID, you must explicitly set it to a different value after a COMMIT or ROLLBACK. Please check GTID_NEXT variable manual page for detailed explanation. Current @@SESSION.GTID_NEXT is '#'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
error ER_GTID_UNSAFE_CREATE_DROP_TEMPORARY_TABLE_IN_TRANSACTION
DROP TEMPORARY TABLE t1;
ERROR HY000: Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
ALTER TABLE t1 ADD COLUMN (b INT);
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
error ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET
DROP TABLE t1;
ERROR HY000: Cannot execute statements with implicit commit inside a transaction when @@SESSION.GTID_NEXT == 'UUID:NUMBER'.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be an Error, not a Warning.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=1 gtid_next=GTID
SET GTID_NEXT = 'GTID';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
******** GTID_MODE=0 ********
SET GLOBAL GTID_MODE = 0;
==== GTID_NEXT=AUTOMATIC ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=AUTOMATIC
SET GTID_NEXT = 'AUTOMATIC';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
==== GTID_NEXT=ANONYMOUS ====
---- CREATE TABLE ... SELECT: violation cases ----
# CREATE ... SELECT (InnoDB): Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT (MyISAM): Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
Warnings:
Warning	1786	Statement violates GTID consistency: CREATE TABLE ... SELECT.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
---- CREATE TABLE ... SELECT: consistent cases ----
# CREATE TEMPORARY ... SELECT: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# CREATE ... SELECT, SQL_LOG_BIN=0: Consistent.
SET SQL_LOG_BIN = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = InnoDB SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TABLE t1 (a INT) ENGINE = MyISAM SELECT 1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 1;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 0;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=0: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: violation cases ----
SET @OLD_BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= 1;
CREATE TABLE myisam1 (a INT) ENGINE = MyISAM;
CREATE TABLE myisam2 (a INT) ENGINE = MyISAM;
CREATE TABLE innodb (a INT) ENGINE = InnoDB;
# InnoDB followed by MyISAM in one trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one autocommit statement: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO myisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by temp MyISAM in one trx, binlog_format=stm: Violation.
SET SESSION BINLOG_FORMAT = STATEMENT;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW INSERT INTO tmyisam1 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement inside trx, binlog_format=stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
Warnings:
Warning	1785	Statement violates GTID consistency: Updates to non-transactional tables can only be done in either autocommitted statements or single-statement transactions, and never in the same statement as updates to transactional tables.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SESSION BINLOG_FORMAT = MIXED;
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using stm: Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one autocommit statement, binlog_format=mix using stm: Violation.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
---- Mixing trx/non-trx updates with binlog_direct_non_transactional_updates=1: consistent cases ----
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
# MyISAM followed by MyISAM, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO myisam2 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# MyISAM and MyISAM in one statement: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON myisam1 FOR EACH ROW INSERT INTO myisam2 VALUES (1);
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# MyISAM followed by InnoDB, in one 'trx': Consistent, except if gtid_next=GTID, it generates ER_GTID_NEXT_TYPE_UNDEFINED_GROUP.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO myisam1 VALUES (1);
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET SESSION BINLOG_FORMAT = MIXED;
INSERT INTO tmyisam1 VALUES (RAND());
# InnoDB followed by temp MyISAM in one trx, binlog_format=mix using row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=mix using row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET BINLOG_FORMAT = ROW;
# InnoDB followed by temp MyISAM in one trx, binlog_format=row: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO tmyisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and temp MyISAM in one statement, binlog_format=row: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO tmyisam1 VALUES (1); INSERT INTO tmyisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
DROP TEMPORARY TABLE tmyisam1, tmyisam2;
SET BINLOG_FORMAT = #;
CREATE TEMPORARY TABLE tmyisam1 (a INT) ENGINE = MyISAM;
CREATE TEMPORARY TABLE tmyisam2 (a INT) ENGINE = MyISAM;
SET SQL_LOG_BIN = 0;
# InnoDB and MyISAM in one statement, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
# InnoDB followed by MyISAM, in one trx, SQL_LOG_BIN=0: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN; INSERT INTO innodb VALUES (1);
INSERT INTO myisam1 VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# InnoDB and MyISAM in one statement inside trx, SQL_LOG_BIN=0: Consistent.
CREATE TRIGGER trig BEFORE INSERT ON innodb FOR EACH ROW BEGIN INSERT INTO myisam1 VALUES (1); INSERT INTO myisam2 VALUES (1); END;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
INSERT INTO innodb VALUES (1);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1196	Some non-transactional changed tables couldn't be rolled back
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TRIGGER trig;
SET SQL_LOG_BIN = 1;
DROP TABLE myisam1, myisam2, tmyisam1, tmyisam2, innodb;
SET @@SESSION.BINLOG_DIRECT_NON_TRANSACTIONAL_UPDATES= @old_binlog_direct_non_transactional_updates;
---- [CREATE|DROP] TEMPORARY TABLE: violation cases ----
# CREATE TEMPORARY in trx (InnoDB, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, BEGIN): Violation.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# CREATE TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0 (stm) / 1 (row)]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
# DROP TEMPORARY in trx (InnoDB, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (MyISAM, BEGIN): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY in trx (InnoDB, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = InnoDB;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 1]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx (MyISAM, AUTOCOMMIT=0): Violation.
CREATE TEMPORARY TABLE IF NOT EXISTS t1 (a INT) ENGINE = MyISAM;
SET AUTOCOMMIT = 0;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
Warnings:
Warning	1787	Statement violates GTID consistency: CREATE TEMPORARY TABLE and DROP TEMPORARY TABLE can only be executed outside transactional context.
include/assert.inc [One warning/error should be generated.]
include/assert.inc [It should be a Warning, not an Error.]
include/assert.inc [Text should be "violates GTID consistency"]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
SET AUTOCOMMIT = 1;
DROP TEMPORARY TABLE IF EXISTS t1;
---- [CREATE|DROP] TEMPORARY TABLE: consistent cases ----
# CREATE TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP TEMPORARY outside trx: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# ALTER without TEMPORARY, on temp table, in trx: Consistent, except if gtid_next=GTID, it generates ER_CANT_DO_IMPLICIT_COMMIT_IN_TRX_WHEN_GTID_NEXT_IS_SET.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
ALTER TABLE t1 ADD COLUMN (b INT);
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
# DROP without TEMPORARY, on temp table: Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
DROP TABLE IF EXISTS t1;
SET SQL_LOG_BIN = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 0;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
# CREATE TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
DROP TEMPORARY TABLE t1;
SET AUTOCOMMIT = 1;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, BEGIN): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
BEGIN;
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 0;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (InnoDB, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = InnoDB;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
# DROP TEMPORARY in trx, SQL_LOG_BIN=0 (MyISAM, AUTOCOMMIT=0): Consistent.
CREATE TEMPORARY TABLE t1 (a INT) ENGINE = MyISAM;
# enforce_gtid_consistency=2 gtid_mode=0 gtid_next=ANONYMOUS
SET GTID_NEXT = 'ANONYMOUS';
DROP TEMPORARY TABLE t1;
include/assert.inc [No warning or error should be generated.]
include/assert.inc [AUTOMATIC_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
include/assert.inc [ANONYMOUS_GTID_VIOLATING_TRANSACTION_COUNT should be 0]
ROLLBACK;
Warnings:
Warning	1751	The creation of some temporary tables could not be rolled back.
Warning	1752	Some temporary tables were dropped, but these operations could not be rolled back.
SET GTID_NEXT = 'AUTOMATIC';
include/assert.inc [Both counters should be 0]
COMMIT;
SET AUTOCOMMIT = 1;
SET SQL_LOG_BIN = 1;
SET GLOBAL ENFORCE_GTID_CONSISTENCY = OFF;
SET GLOBAL SQL_NOTES = @old_sql_notes;
include/rpl_end.inc
